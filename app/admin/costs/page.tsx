"use client"

import { useState, useEffect } from "react"
import { cn } from "@/lib/utils"
import { SmartCard } from "@/components/ui/premium/smart-card"
import { CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { StatsCard } from "@/components/dashboard/stats-card"
import { PremiumLoader } from "@/components/ui/premium/premium-loader"
import {
  DollarSign,
  TrendingUp,
  RefreshCw,
  PieChart as PieChartIcon,
  Target,
  Building2,
} from "lucide-react"
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  PieChart,
  Pie,
  Cell,
  BarChart,
  Bar,
} from "recharts"
import { ChartContainer, ChartTooltip, ChartTooltipContent } from "@/components/ui/chart"
import Link from "next/link"

interface CostsData {
  summary: {
    totalCost: number
    totalRequests: number
    todayCost: number
    weekCost: number
    monthCost: number
    avgCostPerConversation: string
    conversationsThisMonth: number
  }
  breakdown: Array<{
    type: string
    rawType: string
    cost: number
    count: number
    percentage: number
  }>
  history: Array<{
    date: string
    displayDate: string
    cost: number
  }>
  perWorkspace: Array<{
    id: string
    name: string
    today: number
    week: number
    month: number
  }>
}

const COLORS = ['hsl(var(--chart-1))', 'hsl(var(--chart-2))', 'hsl(var(--chart-3))', 'hsl(var(--chart-4))', 'hsl(var(--chart-5))'];

export default function AdminCostsPage() {
  const [data, setData] = useState<CostsData | null>(null)
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)

  useEffect(() => {
    fetchData()
  }, [])

  const fetchData = async (isRefresh = false) => {
    if (isRefresh) setRefreshing(true)
    else setLoading(true)

    try {
      const response = await fetch('/api/admin/costs')
      if (!response.ok) throw new Error('Failed to fetch')
      const result = await response.json()
      setData(result)
    } catch (error) {
      console.error('Error fetching costs:', error)
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }

  if (loading) {
    return <PremiumLoader />
  }

  const targetCost = 2.0 // Target cost per conversation in BDT
  const isUnderTarget = parseFloat(data?.summary.avgCostPerConversation || '0') <= targetCost

  return (
    <div className="p-4 lg:p-6 space-y-8 max-w-[1600px] mx-auto">
      {/* Header - Editorial Style */}
      <div className="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 border-b border-border/40 pb-6">
        <div>
          <h2 className="text-3xl lg:text-4xl font-serif text-foreground tracking-tight">
            Cost Analysis
          </h2>
          <p className="text-sm text-muted-foreground mt-2">System-wide API usage and spending</p>
        </div>
        <Button 
          variant="outline" 
          size="sm" 
          onClick={() => fetchData(true)}
          disabled={refreshing}
          className="h-9 font-medium shadow-sm active:scale-95 transition-all"
        >
          <RefreshCw className={`h-4 w-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />
          Refresh
        </Button>
      </div>

      {/* Cost Summary Cards */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <StatsCard
          title="Today"
          value={`৳${(data?.summary.todayCost || 0).toFixed(4)}`}
          trend={{ value: "", direction: "up", isPositive: true }}
          comparison="API cost today"
          icon={DollarSign}
          isCurrency
        />
        <StatsCard
          title="This Week"
          value={`৳${(data?.summary.weekCost || 0).toFixed(4)}`}
          trend={{ value: "", direction: "up", isPositive: true }}
          comparison="Last 7 days"
          icon={TrendingUp}
          isCurrency
        />
        <StatsCard
          title="This Month"
          value={`৳${(data?.summary.monthCost || 0).toFixed(4)}`}
          trend={{ value: "", direction: "up", isPositive: true }}
          comparison={`${data?.summary.conversationsThisMonth || 0} conversations`}
          icon={DollarSign}
          isCurrency
        />
        <StatsCard
          title="Avg per Conversation"
          value={`৳${data?.summary.avgCostPerConversation || '0.00'}`}
          trend={{ 
            value: isUnderTarget ? "On Target" : "Over Target", 
            direction: isUnderTarget ? "down" : "up", 
            isPositive: isUnderTarget 
          }}
          comparison={`Target: ৳${targetCost.toFixed(2)}`}
          icon={Target}
          isCurrency
        />
      </div>

      {/* Charts Row */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Cost Trend */}
        <SmartCard>
          <CardHeader>
            <CardTitle className="text-lg font-semibold flex items-center gap-2">
              <TrendingUp className="h-5 w-5 text-primary" />
              Cost Trend (Last 30 Days)
            </CardTitle>
          </CardHeader>
          <CardContent>
            <ChartContainer
              config={{
                cost: {
                  label: "Cost",
                  color: "hsl(var(--chart-1))",
                },
              }}
              className="h-[280px] w-full"
            >
              <AreaChart data={data?.history || []}>
                <defs>
                  <linearGradient id="costGradient" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="hsl(var(--chart-1))" stopOpacity={0.3} />
                    <stop offset="95%" stopColor="hsl(var(--chart-1))" stopOpacity={0.05} />
                  </linearGradient>
                </defs>
                <CartesianGrid
                  strokeDasharray="3 3"
                  stroke="var(--border)"
                  strokeOpacity={0.3}
                  vertical={false}
                />
                <XAxis
                  dataKey="displayDate"
                  stroke="var(--muted-foreground)"
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                />
                <YAxis
                  stroke="var(--muted-foreground)"
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                  tickFormatter={(v) => `৳${v.toFixed(2)}`}
                />
                <ChartTooltip content={<ChartTooltipContent />} />
                <Area
                  type="monotone"
                  dataKey="cost"
                  stroke="hsl(var(--chart-1))"
                  strokeWidth={2.5}
                  fill="url(#costGradient)"
                  dot={false}
                  activeDot={{ r: 6, fill: "hsl(var(--chart-1))" }}
                />
              </AreaChart>
            </ChartContainer>
          </CardContent>
        </SmartCard>

        {/* Cost Distribution */}
        <SmartCard>
          <CardHeader>
            <CardTitle className="text-lg font-semibold flex items-center gap-2">
              <PieChartIcon className="h-5 w-5 text-primary" />
              Cost Distribution by API Type
            </CardTitle>
          </CardHeader>
          <CardContent>
            <ChartContainer config={{}} className="h-[280px] w-full">
              <PieChart>
                <Pie
                  data={data?.breakdown || []}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  outerRadius={80}
                  fill="#8884d8"
                  dataKey="cost"
                  nameKey="type"
                  label={({ percent = 0 }) => percent > 0.05 ? `${(percent * 100).toFixed(0)}%` : ''}
                >
                  {(data?.breakdown || []).map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <ChartTooltip 
                  formatter={(value: number) => [`৳${value.toFixed(4)}`, "Cost"]}
                />
              </PieChart>
            </ChartContainer>
          </CardContent>
        </SmartCard>
      </div>

      {/* Detailed Breakdown */}
      <SmartCard>
        <CardHeader>
          <CardTitle className="text-lg font-semibold flex items-center gap-2">
            <DollarSign className="h-5 w-5 text-primary" />
            Detailed Breakdown
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {(data?.breakdown || []).map((item, index) => (
              <div key={item.rawType} className="flex items-center justify-between p-3 rounded-xl border border-border/50 hover:bg-muted/30 transition-colors">
                <div className="flex items-center gap-3">
                  <div 
                    className="w-3 h-3 rounded-full" 
                    style={{ backgroundColor: COLORS[index % COLORS.length] }}
                  />
                  <div>
                    <p className="font-medium text-sm">{item.type}</p>
                    <p className="text-xs text-muted-foreground">{item.count} calls</p>
                  </div>
                </div>
                <div className="text-right">
                  <p className="font-mono font-medium text-sm">৳{item.cost.toFixed(4)}</p>
                  <p className="text-xs text-muted-foreground">{item.percentage.toFixed(1)}%</p>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </SmartCard>

      {/* Per Workspace Breakdown */}
      <SmartCard>
        <CardHeader>
          <CardTitle className="text-lg font-semibold flex items-center gap-2">
            <Building2 className="h-5 w-5 text-primary" />
            Per Workspace Costs
          </CardTitle>
        </CardHeader>
        <CardContent className="p-0">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b border-border">
                  <th className="text-left py-3 px-4 font-medium text-muted-foreground text-xs">Workspace</th>
                  <th className="text-right py-3 px-4 font-medium text-muted-foreground text-xs">Today</th>
                  <th className="text-right py-3 px-4 font-medium text-muted-foreground text-xs">Week</th>
                  <th className="text-right py-3 px-4 font-medium text-muted-foreground text-xs">Month</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-border">
                {(data?.perWorkspace || []).map((ws) => (
                  <tr key={ws.id} className="hover:bg-muted/30 transition-colors">
                    <td className="py-3 px-4">
                      <Link href={`/admin/workspaces/${ws.id}`} className="font-medium text-sm hover:underline">
                        {ws.name}
                      </Link>
                    </td>
                    <td className="text-right py-3 px-4 font-mono text-sm">৳{ws.today.toFixed(4)}</td>
                    <td className="text-right py-3 px-4 font-mono text-sm">৳{ws.week.toFixed(4)}</td>
                    <td className="text-right py-3 px-4 font-mono text-sm">৳{ws.month.toFixed(4)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </CardContent>
      </SmartCard>
    </div>
  )
}
